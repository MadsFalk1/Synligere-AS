---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Minigame | Synligere" description="Word search minigame.">
	<section class="mx-auto w-full max-w-lg px-4 py-10">
		<div class="rounded-3xl border border-[#24140f]/10 bg-white p-6 shadow-[0_14px_32px_-26px_rgba(52,34,24,0.45)] sm:p-8">
			<p class="text-xs font-semibold uppercase tracking-[0.2em] text-[#b56449]">Minigame</p>
			<h1 class="mt-2 text-2xl font-bold tracking-tight text-[#1a1a1a] sm:text-3xl">Word Search ğŸ’›</h1>
			<p class="mt-2 text-sm text-[#4d433e]">Finn to skjulte ord i rutenettet ved Ã¥ dra over bokstavene.</p>
			<div id="minigame-app" class="mt-6"></div>
		</div>
	</section>
</BaseLayout>

<script>
	const app = document.getElementById('minigame-app');
	if (!app) throw new Error('Mangler container');

	const grid = [
		['E', 'L', 'S', 'K', 'E', 'R'],
		['A', 'V', 'N', 'T', 'R', 'M'],
		['I', 'D', 'L', 'P', 'O', 'A'],
		['U', 'E', 'B', 'J', 'K', 'G'],
		['Y', 'G', 'Q', 'E', 'L', 'H'],
		['C', 'W', 'X', 'Z', 'F', 'R'],
	];

	const hiddenWords = ['ELSKER', 'DEG'];
	const found = new Set();
	let selected = [];
	let isDragging = false;
	let showValentine = false;
	let celebrate = false;
	let noScale = 1;
	let yesScale = 1;

	const cellKey = (r, c) => `${r}-${c}`;
	const selectedWord = () => selected.map(({ r, c }) => grid[r][c]).join('');
	const isNeighbor = (a, b) => Math.abs(a.r - b.r) <= 1 && Math.abs(a.c - b.c) <= 1;

	const launchCelebration = () => {
		const root = app.querySelector('#celebration-layer');
		if (!root) return;
		const flowers = ['ğŸŒ¸', 'ğŸŒº', 'ğŸŒ¼', 'ğŸ’', 'ğŸŒ·'];
		const fireworks = ['âœ¨', 'ğŸ†', 'ğŸ‡', 'ğŸ’¥'];

		for (let i = 0; i < 80; i += 1) {
			const node = document.createElement('span');
			node.textContent = flowers[Math.floor(Math.random() * flowers.length)];
			node.className = 'flower-piece';
			node.style.left = `${Math.random() * 100}%`;
			node.style.animationDelay = `${Math.random() * 0.8}s`;
			node.style.fontSize = `${14 + Math.random() * 20}px`;
			node.style.setProperty('--drift', `${-40 + Math.random() * 80}px`);
			root.appendChild(node);
			setTimeout(() => node.remove(), 3200);
		}

		for (let i = 0; i < 24; i += 1) {
			const node = document.createElement('span');
			node.textContent = fireworks[Math.floor(Math.random() * fireworks.length)];
			node.className = 'firework-piece';
			node.style.left = `${10 + Math.random() * 80}%`;
			node.style.top = `${8 + Math.random() * 42}%`;
			node.style.animationDelay = `${Math.random() * 0.9}s`;
			node.style.fontSize = `${22 + Math.random() * 18}px`;
			root.appendChild(node);
			setTimeout(() => node.remove(), 2400);
		}
	};

	const endDrag = () => {
		if (!selected.length) return;
		const word = selectedWord();
		const reversed = word.split('').reverse().join('');

		for (const target of hiddenWords) {
			if (word === target || reversed === target) {
				found.add(target);
			}
		}

		selected = [];
		if (found.size === hiddenWords.length && !showValentine && !celebrate) {
			showValentine = true;
		}
		render();
	};

	const openPlan = () => {
		window.location.href = '/plan';
	};

	const onYes = () => {
		celebrate = true;
		showValentine = false;
		render();
		launchCelebration();
	};

	const render = () => {
		if (celebrate) {
			app.innerHTML = `
				<div class="relative overflow-hidden rounded-2xl border border-[#24140f]/10 bg-[#1e1320] p-6 text-center text-[#fff8f3]">
					<div id="celebration-layer" class="pointer-events-none absolute inset-0"></div>
					<p class="relative z-10 text-2xl font-bold">Yay! ğŸ’–</p>
					<p class="relative z-10 mt-2 text-sm text-[#ffe7df]">Du er min valentine!</p>
					<button id="continue-btn" class="relative z-10 mt-5 w-full rounded-2xl bg-[#ffb199] py-4 text-lg font-semibold text-[#2f1e18]">Se planen</button>
				</div>
			`;
			app.querySelector('#continue-btn')?.addEventListener('click', openPlan);
			return;
		}

		if (showValentine) {
			app.innerHTML = `
				<div class="rounded-2xl border border-[#24140f]/10 bg-[#fff7f3] p-5 text-center">
					<p class="text-lg font-semibold text-[#2a1b16]">Vil du vÃ¦re min valentine? ğŸ’Œ</p>
					<div class="mt-5 flex items-center justify-center gap-3">
						<button id="yes-btn" class="rounded-2xl bg-[#ffb199] px-6 py-3 text-lg font-semibold text-[#2f1e18] transition" style="transform: scale(${yesScale});">Ja</button>
						<button id="no-btn" class="rounded-2xl border border-[#24140f]/20 bg-white px-6 py-3 text-lg font-semibold text-[#2a1b16] transition" style="transform: scale(${noScale});">Nei</button>
					</div>
				</div>
			`;
			app.querySelector('#yes-btn')?.addEventListener('click', onYes);
			app.querySelector('#no-btn')?.addEventListener('click', () => {
				noScale = Math.max(0.42, noScale - 0.16);
				yesScale = Math.min(1.9, yesScale + 0.16);
				render();
			});
			return;
		}

		const selectedSet = new Set(selected.map(({ r, c }) => cellKey(r, c)));
		const foundList = [...found];
		app.innerHTML = `
			<div>
				<div class="mb-4 rounded-2xl border border-[#24140f]/10 bg-[#fffaf7] p-3 text-sm text-[#4d433e]">
					<p class="font-semibold text-[#2a1b16]">Ord funnet: ${found.size}/2</p>
					<div class="mt-2 flex flex-wrap gap-2">
						${
							foundList.length
								? foundList
										.map((word) => `<span class="rounded-full bg-[#effcf4] px-3 py-1 text-xs font-semibold text-[#175b37]">${word} âœ“</span>`)
										.join('')
								: '<span class="text-xs text-[#7d716b]">Ingen ord funnet enda</span>'
						}
					</div>
				</div>
				<div class="grid grid-cols-6 gap-2 touch-none select-none">
					${grid
						.map((row, r) =>
							row
								.map((char, c) => {
									const active = selectedSet.has(cellKey(r, c));
									return `<button data-r="${r}" data-c="${c}" class="cell aspect-square rounded-xl border text-lg font-bold ${active ? 'border-[#ffb199] bg-[#fff1eb] text-[#b56449]' : 'border-[#24140f]/15 bg-white text-[#2a1b16]'}">${char}</button>`;
								})
								.join(''),
						)
						.join('')}
				</div>
				<p class="mt-4 text-center text-sm text-[#6a605a]">Tips: se etter bokstavmÃ¸nstre som skiller seg ut.</p>
			</div>
		`;

		app.querySelectorAll('.cell').forEach((cell) => {
			cell.addEventListener('pointerdown', (event) => {
				isDragging = true;
				const r = Number(cell.getAttribute('data-r'));
				const c = Number(cell.getAttribute('data-c'));
				selected = [{ r, c }];
				cell.setPointerCapture(event.pointerId);
				render();
			});

			cell.addEventListener('pointerenter', () => {
				if (!isDragging) return;
				const r = Number(cell.getAttribute('data-r'));
				const c = Number(cell.getAttribute('data-c'));
				const last = selected[selected.length - 1];
				if (!last || !isNeighbor(last, { r, c })) return;
				if (!selected.some((item) => item.r === r && item.c === c)) {
					selected.push({ r, c });
					render();
				}
			});

			cell.addEventListener('pointerup', () => {
				isDragging = false;
				endDrag();
			});
		});

		document.addEventListener(
			'pointerup',
			() => {
				if (isDragging) {
					isDragging = false;
					endDrag();
				}
			},
			{ once: true },
		);
	};

	render();
</script>

<style>
	.flower-piece {
		position: absolute;
		top: -14%;
		animation: flower-fall 2.8s cubic-bezier(0.2, 0.7, 0.2, 1) forwards;
		filter: drop-shadow(0 6px 8px rgba(0, 0, 0, 0.25));
	}

	.firework-piece {
		position: absolute;
		animation: firework-burst 1.3s ease-out forwards;
		text-shadow: 0 0 15px rgba(255, 255, 255, 0.9);
	}

	@keyframes flower-fall {
		0% {
			transform: translate3d(0, 0, 0) rotate(0deg);
			opacity: 0;
		}
		10% {
			opacity: 1;
		}
		100% {
			transform: translate3d(var(--drift), 125vh, 0) rotate(480deg);
			opacity: 0;
		}
	}

	@keyframes firework-burst {
		0% {
			transform: scale(0.2);
			opacity: 0;
		}
		40% {
			transform: scale(1.4);
			opacity: 1;
		}
		100% {
			transform: scale(0.9);
			opacity: 0;
		}
	}
</style>
