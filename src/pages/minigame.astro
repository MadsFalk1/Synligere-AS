---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Minigame | Synligere" description="Word search: finn ordene elsker og deg.">
	<section class="mx-auto w-full max-w-lg px-4 py-10">
		<div class="rounded-3xl border border-[#24140f]/10 bg-white p-6 shadow-[0_14px_32px_-26px_rgba(52,34,24,0.45)] sm:p-8">
			<p class="text-xs font-semibold uppercase tracking-[0.2em] text-[#b56449]">Minigame</p>
			<h1 class="mt-2 text-2xl font-bold tracking-tight text-[#1a1a1a] sm:text-3xl">Word Search ğŸ’›</h1>
			<p class="mt-2 text-sm text-[#4d433e]">Finn to ord i rutenettet ved Ã¥ dra over bokstavene.</p>
			<div id="minigame-app" class="mt-6"></div>
		</div>
	</section>
</BaseLayout>

<script>
	const app = document.getElementById('minigame-app');
	if (!app) throw new Error('Mangler container');

	const grid = [
		['E', 'L', 'S', 'K', 'E', 'R'],
		['A', 'V', 'N', 'T', 'R', 'M'],
		['I', 'D', 'L', 'P', 'O', 'A'],
		['U', 'E', 'B', 'J', 'K', 'G'],
		['Y', 'G', 'Q', 'E', 'L', 'H'],
		['C', 'W', 'X', 'Z', 'F', 'R'],
	];
	const targets = ['ELSKER', 'DEG'];
	const found = new Set();
	let selected = [];
	let isDragging = false;
	let asked = false;
	let noScale = 1;

	const cellKey = (r, c) => `${r}-${c}`;

	const selectedWord = () => selected.map(({ r, c }) => grid[r][c]).join('');

	const isNeighbor = (a, b) => Math.abs(a.r - b.r) <= 1 && Math.abs(a.c - b.c) <= 1;

	const endDrag = () => {
		if (!selected.length) return;
		const word = selectedWord();
		const reversed = word.split('').reverse().join('');
		for (const target of targets) {
			if (word === target || reversed === target) {
				found.add(target);
			}
		}
		selected = [];
		render();
		if (found.size === targets.length && !asked) {
			asked = true;
			setTimeout(() => {
				render();
				launchFlowers();
			}, 220);
		}
	};

	const launchFlowers = () => {
		const layer = app.querySelector('#flowers');
		if (!layer) return;
		const flowers = ['ğŸŒ¸', 'ğŸŒº', 'ğŸŒ¼', 'ğŸ’'];
		for (let i = 0; i < 30; i += 1) {
			const f = document.createElement('span');
			f.textContent = flowers[Math.floor(Math.random() * flowers.length)];
			f.className = 'flower';
			f.style.left = `${Math.random() * 100}%`;
			f.style.animationDelay = `${Math.random() * 0.5}s`;
			f.style.fontSize = `${16 + Math.random() * 16}px`;
			layer.appendChild(f);
			setTimeout(() => f.remove(), 2200);
		}
	};

	const openPlan = () => {
		window.location.href = '/plan';
	};

	const render = () => {
		if (asked) {
			app.innerHTML = `
				<div class="relative overflow-hidden rounded-2xl border border-[#24140f]/10 bg-[#fff7f3] p-5 text-center">
					<div id="flowers" class="pointer-events-none absolute inset-0"></div>
					<p class="text-lg font-semibold text-[#2a1b16]">Vil du vÃ¦re min valentine? ğŸ’Œ</p>
					<div class="mt-5 flex items-center justify-center gap-3">
						<button id="yes-btn" class="rounded-2xl bg-[#ffb199] px-6 py-3 text-lg font-semibold text-[#2f1e18]" style="transform: scale(${2 - noScale});">Ja</button>
						<button id="no-btn" class="rounded-2xl border border-[#24140f]/20 bg-white px-6 py-3 text-lg font-semibold text-[#2a1b16]" style="transform: scale(${noScale});">Nei</button>
					</div>
				</div>
			`;
			app.querySelector('#yes-btn')?.addEventListener('click', openPlan);
			app.querySelector('#no-btn')?.addEventListener('click', () => {
				noScale = Math.max(0.45, noScale - 0.18);
				render();
			});
			return;
		}

		const selectedSet = new Set(selected.map(({ r, c }) => cellKey(r, c)));
		app.innerHTML = `
			<div>
				<div class="mb-4 rounded-2xl border border-[#24140f]/10 bg-[#fffaf7] p-3 text-sm text-[#4d433e]">
					Finn: <span class="font-semibold ${found.has('ELSKER') ? 'text-[#175b37]' : 'text-[#2a1b16]'}">ELSKER</span> og
					<span class="font-semibold ${found.has('DEG') ? 'text-[#175b37]' : 'text-[#2a1b16]'}">DEG</span>
				</div>
				<div class="grid grid-cols-6 gap-2 touch-none select-none">
					${grid
						.map((row, r) =>
							row
								.map((char, c) => {
									const active = selectedSet.has(cellKey(r, c));
									return `<button data-r="${r}" data-c="${c}" class="cell aspect-square rounded-xl border text-lg font-bold ${active ? 'border-[#ffb199] bg-[#fff1eb] text-[#b56449]' : 'border-[#24140f]/15 bg-white text-[#2a1b16]'}">${char}</button>`;
								})
								.join(''),
						)
						.join('')}
				</div>
				<p class="mt-4 text-center text-sm text-[#6a605a]">Dra over bokstavene i riktig rekkefÃ¸lge.</p>
			</div>
		`;

		app.querySelectorAll('.cell').forEach((cell) => {
			cell.addEventListener('pointerdown', (event) => {
				isDragging = true;
				const r = Number(cell.getAttribute('data-r'));
				const c = Number(cell.getAttribute('data-c'));
				selected = [{ r, c }];
				cell.setPointerCapture(event.pointerId);
				render();
			});

			cell.addEventListener('pointerenter', () => {
				if (!isDragging) return;
				const r = Number(cell.getAttribute('data-r'));
				const c = Number(cell.getAttribute('data-c'));
				const last = selected[selected.length - 1];
				if (!last || !isNeighbor(last, { r, c })) return;
				if (!selected.some((item) => item.r === r && item.c === c)) {
					selected.push({ r, c });
					render();
				}
			});

			cell.addEventListener('pointerup', () => {
				isDragging = false;
				endDrag();
			});
		});

		document.addEventListener(
			'pointerup',
			() => {
				if (isDragging) {
					isDragging = false;
					endDrag();
				}
			},
			{ once: true },
		);
	};

	render();
</script>

<style>
	.flower {
		position: absolute;
		top: -10%;
		animation: flower-fall 1.9s ease-in forwards;
	}

	@keyframes flower-fall {
		0% {
			transform: translate3d(0, 0, 0) rotate(0deg);
			opacity: 0;
		}
		10% {
			opacity: 1;
		}
		100% {
			transform: translate3d(-12px, 120vh, 0) rotate(280deg);
			opacity: 0;
		}
	}
</style>
