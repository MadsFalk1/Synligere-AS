---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Minigame | Synligere" description="Dra bokstaver for Ã¥ finne riktig setning.">
	<section class="mx-auto w-full max-w-lg px-4 py-10">
		<div class="rounded-3xl border border-[#24140f]/10 bg-white p-6 shadow-[0_14px_32px_-26px_rgba(52,34,24,0.45)] sm:p-8">
			<p class="text-xs font-semibold uppercase tracking-[0.2em] text-[#b56449]">Minigame</p>
			<h1 class="mt-2 text-2xl font-bold tracking-tight text-[#1a1a1a] sm:text-3xl">Dra bokstavene til riktig plass</h1>
			<p class="mt-2 text-sm text-[#4d433e]">Finn den skjulte setningen ved Ã¥ dra bokstavene.</p>
			<div id="minigame-app" class="mt-6"></div>
		</div>
	</section>
</BaseLayout>

<script>
	const target = 'ELSKER DEG';
	const pool = ['E', 'L', 'S', 'K', 'E', 'R', 'D', 'E', 'G', 'A', 'B', 'H', 'N', 'O', 'T'];
	const slotsTemplate = target.split('').map((char) => (char === ' ' ? 'space' : null));
	const app = document.getElementById('minigame-app');

	if (!app) throw new Error('Minigame container mangler.');

	let slots = [...slotsTemplate];
	let gaveUp = false;
	let isSuccess = false;
	let dragIndex = -1;
	let ghost = null;

	const usedLetters = () => slots.filter((value) => value && value !== 'space');
	const canUseLetter = (letter) => usedLetters().filter((char) => char === letter).length < pool.filter((char) => char === letter).length;

	const checkComplete = () => {
		const attempt = slots.map((char) => (char === 'space' ? ' ' : char || '')).join('');
		if (attempt.length === target.length && attempt === target) {
			isSuccess = true;
		}
	};

	const launchFlowers = () => {
		const container = app.querySelector('#flowers');
		if (!container) return;
		const flowers = ['ğŸŒ¸', 'ğŸŒº', 'ğŸŒ¼', 'ğŸ’'];
		for (let i = 0; i < 28; i += 1) {
			const el = document.createElement('span');
			el.textContent = flowers[Math.floor(Math.random() * flowers.length)];
			el.className = 'flower';
			el.style.left = `${Math.random() * 100}%`;
			el.style.animationDelay = `${Math.random() * 0.6}s`;
			el.style.fontSize = `${18 + Math.random() * 16}px`;
			container.appendChild(el);
			setTimeout(() => el.remove(), 2200);
		}
	};

	const render = () => {
		if (gaveUp) {
			app.innerHTML = `
				<div class="space-y-4 rounded-2xl border border-[#24140f]/10 bg-[#fff7f3] p-5 text-center">
					<p class="text-lg font-semibold text-[#2a1b16]">Du ga opp ğŸ’›</p>
					<p class="text-sm text-[#4d433e]">Riktig svar: <span class="font-bold">elsker deg</span></p>
					<button id="continue-btn" class="w-full py-4 text-lg rounded-2xl bg-[#ffb199] font-semibold text-[#2f1e18]">Fortsett</button>
				</div>
			`;
			app.querySelector('#continue-btn')?.addEventListener('click', () => {
				window.location.href = '/plan';
			});
			return;
		}

		if (isSuccess) {
			app.innerHTML = `
				<div class="relative space-y-4 overflow-hidden rounded-2xl border border-[#24140f]/10 bg-[#effcf4] p-5 text-center">
					<div id="flowers" class="pointer-events-none absolute inset-0"></div>
					<p class="text-lg font-semibold text-[#175b37]">Riktig! ğŸ’š</p>
					<p class="text-sm text-[#2f4b3d]">Du fant setningen.</p>
					<button id="continue-btn" class="w-full py-4 text-lg rounded-2xl bg-[#ffb199] font-semibold text-[#2f1e18]">Fortsett</button>
				</div>
			`;
			launchFlowers();
			app.querySelector('#continue-btn')?.addEventListener('click', () => {
				window.location.href = '/plan';
			});
			return;
		}

		app.innerHTML = `
			<div>
				<p class="text-sm font-semibold uppercase tracking-[0.16em] text-[#8f4b35]">Setning</p>
				<div class="mt-3 grid grid-cols-5 gap-2 sm:grid-cols-10">
					${slots
						.map((slot, index) =>
							slot === 'space'
								? `<div class="h-14 rounded-2xl border border-dashed border-transparent bg-transparent"></div>`
								: `<button data-slot="${index}" class="slot h-14 rounded-2xl border border-[#24140f]/15 bg-[#fffaf7] text-xl font-semibold text-[#2a1b16]">${slot || ''}</button>`,
						)
						.join('')}
				</div>

				<p class="mt-6 text-sm font-semibold uppercase tracking-[0.16em] text-[#8f4b35]">Dra herfra</p>
				<div class="mt-3 grid grid-cols-3 gap-3 sm:grid-cols-5">
					${pool
						.map((letter, index) => {
							const disabled = !canUseLetter(letter);
							return `<button data-letter="${letter}" data-index="${index}" class="drag-letter w-full py-4 text-lg rounded-2xl border border-[#24140f]/15 bg-white font-semibold text-[#2a1b16] ${disabled ? 'opacity-35' : ''}" ${disabled ? 'disabled' : ''}>${letter}</button>`;
						})
						.join('')}
				</div>

				<div class="mt-5 grid grid-cols-2 gap-3">
					<button id="undo-btn" class="w-full py-4 text-lg rounded-2xl border border-[#24140f]/15 bg-white font-semibold text-[#2a1b16]">Angre</button>
					<button id="give-up-btn" class="w-full py-4 text-lg rounded-2xl bg-[#2a1b16] font-semibold text-[#fffaf7]">Gi opp</button>
				</div>
			</div>
		`;

		app.querySelectorAll('.slot').forEach((slotButton) => {
			slotButton.addEventListener('click', () => {
				const index = Number(slotButton.getAttribute('data-slot'));
				if (slots[index]) slots[index] = null;
				render();
			});
		});

		const placeLetter = (letter, slotIndex) => {
			if (!Number.isInteger(slotIndex)) return;
			if (slots[slotIndex] === 'space') return;
			if (slots[slotIndex]) return;
			slots[slotIndex] = letter;
			checkComplete();
			render();
		};

		const createGhost = (char, x, y) => {
			const el = document.createElement('div');
			el.textContent = char;
			el.className = 'pointer-events-none fixed z-[999] flex h-12 w-12 -translate-x-1/2 -translate-y-1/2 items-center justify-center rounded-2xl border border-[#24140f]/20 bg-white text-xl font-bold text-[#2a1b16] shadow-lg';
			el.style.left = `${x}px`;
			el.style.top = `${y}px`;
			document.body.appendChild(el);
			return el;
		};

		app.querySelectorAll('.drag-letter').forEach((letterBtn) => {
			letterBtn.addEventListener('pointerdown', (event) => {
				dragIndex = Number(letterBtn.getAttribute('data-index'));
				const letter = letterBtn.getAttribute('data-letter') || '';
				ghost = createGhost(letter, event.clientX, event.clientY);
				letterBtn.setPointerCapture(event.pointerId);
			});

			letterBtn.addEventListener('pointermove', (event) => {
				if (!ghost || dragIndex < 0) return;
				ghost.style.left = `${event.clientX}px`;
				ghost.style.top = `${event.clientY}px`;
			});

			letterBtn.addEventListener('pointerup', (event) => {
				const letter = letterBtn.getAttribute('data-letter') || '';
				if (ghost) ghost.remove();
				ghost = null;

				const element = document.elementFromPoint(event.clientX, event.clientY);
				const slot = element?.closest?.('.slot');
				if (slot) {
					placeLetter(letter, Number(slot.getAttribute('data-slot')));
				}
				dragIndex = -1;
			});
		});

		app.querySelector('#undo-btn')?.addEventListener('click', () => {
			for (let i = slots.length - 1; i >= 0; i -= 1) {
				if (slots[i] && slots[i] !== 'space') {
					slots[i] = null;
					break;
				}
			}
			render();
		});

		app.querySelector('#give-up-btn')?.addEventListener('click', () => {
			gaveUp = true;
			render();
		});
	};

	render();
</script>

<style>
	.flower {
		position: absolute;
		top: -12%;
		animation: flower-fall 1.9s ease-in forwards;
	}

	@keyframes flower-fall {
		0% {
			transform: translate3d(0, 0, 0) rotate(0deg);
			opacity: 0;
		}
		10% {
			opacity: 1;
		}
		100% {
			transform: translate3d(-18px, 120vh, 0) rotate(260deg);
			opacity: 0;
		}
	}
</style>
