---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Minigame | Synligere" description="Word search minigame.">
	<section class="mx-auto w-full max-w-lg px-4 py-10">
		<div class="rounded-3xl border border-[#24140f]/10 bg-white p-6 shadow-[0_14px_32px_-26px_rgba(52,34,24,0.45)] sm:p-8">
			<p class="text-xs font-semibold uppercase tracking-[0.2em] text-[#b56449]">Minigame</p>
			<h1 class="mt-2 text-2xl font-bold tracking-tight text-[#1a1a1a] sm:text-3xl">Word Search ðŸ’›</h1>
			<p class="mt-2 text-sm text-[#4d433e]">Finn to skjulte ord i rutenettet ved Ã¥ dra over bokstavene.</p>
			<div id="minigame-app" class="mt-6"></div>
		</div>
	</section>
</BaseLayout>

<script>
	const app = document.getElementById('minigame-app');
	if (!app) throw new Error('Mangler container');

	const grid = [
		['E', 'L', 'S', 'K', 'E', 'R'],
		['A', 'V', 'N', 'T', 'R', 'M'],
		['I', 'D', 'L', 'P', 'O', 'A'],
		['U', 'E', 'B', 'J', 'K', 'G'],
		['Y', 'G', 'Q', 'E', 'L', 'H'],
		['C', 'W', 'X', 'Z', 'F', 'R'],
	];

	const hiddenWords = ['ELSKER', 'DEG'];
	const found = new Set();
	let selected = [];
	let isDragging = false;
	let showValentine = false;
	let celebrate = false;
	let noScale = 1;
	let yesScale = 1;
	let celebrationTimer = null;

	const cellKey = (r, c) => `${r}-${c}`;
	const selectedWord = () => selected.map(({ r, c }) => grid[r][c]).join('');
	const isNeighbor = (a, b) => Math.abs(a.r - b.r) <= 1 && Math.abs(a.c - b.c) <= 1;

	const ensureGlobalLayer = () => {
		let layer = document.getElementById('global-celebration-layer');
		if (!layer) {
			layer = document.createElement('div');
			layer.id = 'global-celebration-layer';
			layer.className = 'pointer-events-none fixed inset-0 z-[120] overflow-hidden';
			document.body.appendChild(layer);
		}
		return layer;
	};

	const clearGlobalLayer = () => {
		const layer = document.getElementById('global-celebration-layer');
		if (layer) layer.innerHTML = '';
	};

	const spawnBurst = (root, x, y) => {
		const burst = document.createElement('div');
		burst.className = 'burst';
		burst.style.left = `${x}%`;
		burst.style.top = `${y}%`;
		root.appendChild(burst);

		const colors = ['#ffd86b', '#ff8bb8', '#9de3ff', '#fff2b6', '#c9a8ff', '#7dffb8'];
		for (let i = 0; i < 30; i += 1) {
			const spark = document.createElement('span');
			spark.className = 'spark';
			spark.style.setProperty('--angle', `${(360 / 30) * i}deg`);
			spark.style.setProperty('--distance', `${65 + Math.random() * 130}px`);
			spark.style.background = colors[Math.floor(Math.random() * colors.length)];
			burst.appendChild(spark);
		}

		const flowerEmojis = ['ðŸŒ¸', 'ðŸŒº', 'ðŸŒ¼', 'ðŸ’', 'ðŸŒ·'];
		for (let i = 0; i < 28; i += 1) {
			const petal = document.createElement('span');
			petal.className = 'petal';
			petal.textContent = flowerEmojis[Math.floor(Math.random() * flowerEmojis.length)];
			petal.style.left = `${Math.random() * 100}%`;
			petal.style.animationDelay = `${Math.random() * 0.24}s`;
			petal.style.setProperty('--drift', `${-75 + Math.random() * 150}px`);
			petal.style.fontSize = `${18 + Math.random() * 22}px`;
			root.appendChild(petal);
		}

		setTimeout(() => burst.remove(), 1700);
	};

	const launchCelebration = () => {
		const root = ensureGlobalLayer();
		root.innerHTML = '';

		for (let i = 0; i < 5; i += 1) {
			spawnBurst(root, 10 + Math.random() * 80, 12 + Math.random() * 36);
		}

		let cycles = 0;
		celebrationTimer = setInterval(() => {
			spawnBurst(root, 5 + Math.random() * 90, 8 + Math.random() * 45);
			cycles += 1;
			if (cycles > 15 && celebrationTimer) {
				clearInterval(celebrationTimer);
				celebrationTimer = null;
			}
		}, 260);
	};

	const endDrag = () => {
		if (!selected.length) return;
		const word = selectedWord();
		const reversed = word.split('').reverse().join('');

		for (const target of hiddenWords) {
			if (word === target || reversed === target) found.add(target);
		}

		selected = [];
		if (found.size === hiddenWords.length && !showValentine && !celebrate) showValentine = true;
		render();
	};

	const openPlan = () => {
		clearGlobalLayer();
		window.location.href = '/plan';
	};

	const onYes = () => {
		celebrate = true;
		showValentine = false;
		render();
		launchCelebration();
	};

	const render = () => {
		if (!celebrate) clearGlobalLayer();
		if (!celebrate && celebrationTimer) {
			clearInterval(celebrationTimer);
			celebrationTimer = null;
		}

		if (celebrate) {
			app.innerHTML = `
				<div class="relative overflow-hidden rounded-2xl border border-[#24140f]/10 bg-[#140d1c] p-6 text-center text-[#fff8f3]">
					<div class="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(255,171,199,0.2),transparent_55%)]"></div>
					<p class="relative z-10 text-2xl font-bold">Yay! ðŸ’–</p>
					<p class="relative z-10 mt-2 text-sm text-[#ffe7df]">Du er min valentine!</p>
					<button id="continue-btn" class="relative z-10 mt-5 w-full rounded-2xl bg-[#ffb199] py-4 text-lg font-semibold text-[#2f1e18]">Se planen</button>
				</div>
			`;
			app.querySelector('#continue-btn')?.addEventListener('click', openPlan);
			return;
		}

		if (showValentine) {
			app.innerHTML = `
				<div class="rounded-2xl border border-[#24140f]/10 bg-[#fff7f3] p-5 text-center">
					<p class="text-lg font-semibold text-[#2a1b16]">Vil du vÃ¦re min valentine? ðŸ’Œ</p>
					<div class="mt-5 flex items-center justify-center gap-3">
						<button id="yes-btn" class="rounded-2xl bg-[#ffb199] px-6 py-3 text-lg font-semibold text-[#2f1e18] transition" style="transform: scale(${yesScale});">Ja</button>
						<button id="no-btn" class="rounded-2xl border border-[#24140f]/20 bg-white px-6 py-3 text-lg font-semibold text-[#2a1b16] transition" style="transform: scale(${noScale});">Nei</button>
					</div>
				</div>
			`;
			app.querySelector('#yes-btn')?.addEventListener('click', onYes);
			app.querySelector('#no-btn')?.addEventListener('click', () => {
				noScale = Math.max(0.42, noScale - 0.16);
				yesScale = Math.min(1.9, yesScale + 0.16);
				render();
			});
			return;
		}

		const selectedSet = new Set(selected.map(({ r, c }) => cellKey(r, c)));
		const foundList = [...found];
		app.innerHTML = `
			<div>
				<div class="mb-4 rounded-2xl border border-[#24140f]/10 bg-[#fffaf7] p-3 text-sm text-[#4d433e]">
					<p class="font-semibold text-[#2a1b16]">Ord funnet: ${found.size}/2</p>
					<div class="mt-2 flex flex-wrap gap-2">
						${
							foundList.length
								? foundList
									.map((word) => `<span class="rounded-full bg-[#effcf4] px-3 py-1 text-xs font-semibold text-[#175b37]">${word} âœ“</span>`)
									.join('')
								: '<span class="text-xs text-[#7d716b]">Ingen ord funnet enda</span>'
						}
					</div>
				</div>
				<div class="grid grid-cols-6 gap-2 touch-none select-none">
					${grid
						.map((row, r) =>
							row
								.map((char, c) => {
									const active = selectedSet.has(cellKey(r, c));
									return `<button data-r="${r}" data-c="${c}" class="cell aspect-square rounded-xl border text-lg font-bold ${active ? 'border-[#ffb199] bg-[#fff1eb] text-[#b56449]' : 'border-[#24140f]/15 bg-white text-[#2a1b16]'}">${char}</button>`;
								})
								.join(''),
						)
						.join('')}
				</div>
				<p class="mt-4 text-center text-sm text-[#6a605a]">Tips: se etter bokstavmÃ¸nstre som skiller seg ut.</p>
			</div>
		`;

		app.querySelectorAll('.cell').forEach((cell) => {
			cell.addEventListener('pointerdown', (event) => {
				isDragging = true;
				const r = Number(cell.getAttribute('data-r'));
				const c = Number(cell.getAttribute('data-c'));
				selected = [{ r, c }];
				cell.setPointerCapture(event.pointerId);
				render();
			});

			cell.addEventListener('pointerenter', () => {
				if (!isDragging) return;
				const r = Number(cell.getAttribute('data-r'));
				const c = Number(cell.getAttribute('data-c'));
				const last = selected[selected.length - 1];
				if (!last || !isNeighbor(last, { r, c })) return;
				if (!selected.some((item) => item.r === r && item.c === c)) {
					selected.push({ r, c });
					render();
				}
			});

			cell.addEventListener('pointerup', () => {
				isDragging = false;
				endDrag();
			});
		});

		document.addEventListener('pointerup', () => {
			if (isDragging) {
				isDragging = false;
				endDrag();
			}
		}, { once: true });
	};

	render();
</script>

<style>
	.burst {
		position: absolute;
		transform: translate(-50%, -50%);
	}

	.spark {
		position: absolute;
		left: 0;
		top: 0;
		width: 6px;
		height: 6px;
		border-radius: 999px;
		animation: spark 1.2s ease-out forwards;
		transform: rotate(var(--angle)) translateX(0);
		box-shadow: 0 0 12px currentColor;
	}

	.petal {
		position: absolute;
		top: -12%;
		animation: petal-fall 3s cubic-bezier(0.22, 0.74, 0.25, 1) forwards;
		filter: drop-shadow(0 6px 10px rgba(0, 0, 0, 0.35));
	}

	@keyframes spark {
		0% { opacity: 1; transform: rotate(var(--angle)) translateX(0) scale(1); }
		100% { opacity: 0; transform: rotate(var(--angle)) translateX(var(--distance)) scale(0.15); }
	}

	@keyframes petal-fall {
		0% { transform: translate3d(0, 0, 0) rotate(0deg); opacity: 0; }
		8% { opacity: 1; }
		100% { transform: translate3d(var(--drift), 120vh, 0) rotate(460deg); opacity: 0; }
	}
</style>
